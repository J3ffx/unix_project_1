#!/bin/bash
initialisation(){ echo "http://www.allocine.fr/film/agenda/WEEK" > sitelist | echo "http://www.premiere.fr/Cinema/Films-et-seances/Sorties-Cinema/WEEK" >> sitelist | echo "https://www.telerama.fr/cine/film_datesortie.php?when%5Bdate%5D=WEEK&when_radios=1" >> sitelist | echo "https://www.senscritique.com/films/sorties-cinema/WEEK" >> sitelist; } && cleard(){ rm -f data*; } && erase(){ rm -f ana*; } && download(){ day=$(echo $1 | cut -d/ -f2) month=$(echo $1 | cut -d/ -f1) year=$(echo $1 | cut -d/ -f3) week=$(date -d "$year$month$day" +%V) && if [ "$2" = 'allocine' -o "$2" = 'allo' -o "$2" = '1' -o "$2" = '-' ]; then if [ ! -e data_allocine ]; then curl --silent `grep  'allocine' sitelist | sed "s+WEEK+sem-$year-$month-$day/+g"` > data_allocine; fi; fi && if [ "$2" = 'premiere' -o "$2" = 'prem' -o "$2" = '2' -o "$2" = '-' ]; then if [ ! -e data_premiere ]; then curl --silent `grep  'premiere' sitelist | sed "s+WEEK+$week/$year+g"` > data_premiere; grep -E "tabindex=\"0\">Bandes-annonces</a>" data_premiere | sed -e 's+<a\ href="+http://www.premiere.fr+g' | sed -e 's+"\ tabindex="0">Bandes-annonces</a>++g' > temp; i=1 && while read lnk; do curl --silent -a firefox $lnk > data_prem$i; ((i++)); done < temp; rm -f temp; fi; fi && if [ "$2" = 'telerama' -o "$2" = 'tele' -o "$2" = '3' -o "$2" = '-' ]; then if [ ! -e data_telerama ]; then i=0 && while ((i!=10)) ; do lnk=`grep  'telerama' sitelist | sed "s+WEEK+$day/$month/$year+g"` && lnk_p=`echo "$lnk&page=$i"` && curl --silent $lnk_p > temp; cd=`grep -E "Désolé" temp  | cut -c 10` && if [ "$cd" = "D" ]; then break; fi && cat temp >> data_telerama; ((i++)); done && rm -f temp; fi; fi && if [ "$2" = 'senscritique' -o "$2" = 'sens' -o "$2" = '4' -o "$2" = '-' ]; then if [ ! -e data_senscritique ]; then i=1 && while ((i!=10)) ; do lnk=`grep  'senscritique' sitelist | sed "s+WEEK+$year/semaine/$week+g"` && lnk_p=`echo "$lnk/page-$i"` && curl --silent $lnk_p > temp; cd=`grep -E -m 1 'Bande-annonce' temp  | cut -c 35` && if [ "$cd" != "B" ]; then break; fi && cat temp >> data_senscritique; ((i++)); done && rm -f temp; fi; fi; } && locald(){ sed -e 's+http://+htpp://localhost/+g' -i sitelist; sed -e 's+https://+htpp://localhost/+g' -i sitelist; ./scraper.sh -t $1 $2; } && analysis(){ if [ -e data_allocine ]; then grep -E "fichefilm_gen_cfilm=" data_allocine | sed -e 's+[^ ]*">++g' | sed -e 's+[^ ]*"++g' | sed -e 's+[^ ]*<a++g' | sed -e 's+<[^ ]*++g' | sed -e 's+[^ ]*\ \ ++g' > ana_tit_allo && n=`wc -l ana_tit_allo | sed -e 's+\ ana_tit_allo++g' | grep -E '[0-99]'` && grep -E "width=\"216\"\ height=\"288\"" data_allocine | sed -e 's+[^ ]*\ \ ++g' | sed -e 's+\<img\ class=\"thumbnail-img\"\ ++g' | sed -e 's+\ +_+g' | sed -e 's+\"_alt=[^ ]*++g' | sed -e 's+<src=\"++g' | sed -e 's+[^ ]*_data-src=\"++g' > ana_pic_allo && grep -E -A7 "<div\ class=\"synopsis\">" data_allocine | sed -e 's+\ +_+g' | sed -e 's+____________<[^ ]*++g' | sed -e 's+__________<[^ ]*++g' | sed -e 's+____________________________++g' | sed -e 's+____++g' | sed -e 's+___________________++g' | sed -e 's+________________++g' | sed -e 's+___++g' | grep -E "__" | sed -e 's+__++g' | sed -e 's+_+\ +g' | sed -e "s+\&amp;+\&+g" > ana_syn_allo && grep -E -A39 "<div\ class=\"rating-holder\">" data_allocine > data_temp | echo "--" >> data_temp | sed -e 's+--+_+g' -i data_temp && grep -E -B23 "_" data_temp | sed '/--/c\' | sed '/<div class="rating-item/c\' | sed '/<span class/c\' | sed '/ <\/div>/c\' | sed '/buttons-holder/c\' | sed -e 's+</span></div>++g' | sed -e 's+\ ++g' | sed -e 's+\	++g' | sed '/span/c\' | sed '/--/c\' | sed '1s/^/_\n/' > data_tmp && grep -E -A1 "_" data_tmp > data_spect && grep -E -B2 "_" data_tmp > data_presst && rm -f data_temp && rm -f data_tmp && i=1 && t=2 && while ((i!=$n+1)); do head -$t data_spect | tail -1 && t=$(($t+3)) && ((i++)); done > ana_ras_allo && rm -f data_spect && i=1 && t=3 && while ((i!=$n+1)); do head -$t data_presst | tail -1 && t=$(($t+4)) && ((i++)); done > ana_rap_allo && rm -f data_presst && sed -e 's+\ ++g' -i ana_ras_allo && sed -e 's+,+.+g' -i ana_ras_allo && sed -e 's+\ ++g' -i ana_rap_allo && sed -e 's+,+.+g' -i ana_rap_allo && paste ana_tit_allo ana_pic_allo ana_syn_allo ana_rap_allo ana_ras_allo | while IFS="$(printf '\t')" read -r f1 f2 f3 f4 f5; do printf "%s\n" "$f1" && printf "%s\n" "$f2" && printf "%s\n" "$f3" && printf "%s\n" "$f4" && printf "%s\n\n" "$f5"; done > ana_allocine && rm -f ana_pic_allo && rm -f ana_syn_allo && rm -f ana_ras_allo && rm -f ana_rap_allo; fi && if [ -e data_premiere ]; then grep -E "class=\"thumbnail-title\"><strong class=\"item-title\">" data_premiere | sed -e 's+[^ ]*">++g' | sed -e 's+[^ ]*"++g' | sed -e 's+[^ ]*<a++g' | sed -e 's+<[^ ]*++g' | sed -e 's+[^ ]*\ \ ++g' > ana_tit_prem && n=`wc -l ana_tit_prem | sed -e 's+\ ana_tit_prem++g' | grep -E '[0-99]'` && i=1 && while ((i!=$n+1)); do grep -E -B1 "<meta\ property=\"position\"\ content=\"3\"\ />" data_prem$i > data_typtmp$i; grep -E -A9 "internautes" data_prem$i > data_rattmp$i; grep -E ">[^ ]*<" data_typtmp$i > data_typtm$i; grep -E "rating-value" data_rattmp$i > data_rattm$i; grep -E "allow" data_prem$i > data_tra$i; rm -f data_typtmp$i; rm -f data_rattmp$i; sed -e 's+\ +_+g' -i data_typtm$i; sed -e 's+[^ ]*"name">++g' -i data_typtm$i; sed -e 's+<[^ ]*++g' -i data_typtm$i; sed -e 's+_+\ +g' -i data_typtm$i; typ=`grep -E "[^ ]*" data_typtm$i` && echo "$typ" >> ana_typ_prem; rm -f data_typtm$i; sed -e 's+\ +_+g' -i data_rattm$i; sed -e 's+[^ ]*\">++g' -i data_rattm$i; sed -e 's+_([^ ]*++g' -i data_rattm$i; rat=`grep -E "[^ ]*" data_rattm$i` && echo "$rat" >> ana_rat_prem; rm -f data_rattm$i; sed -e 's+\ +_+g' -i data_tra$i; sed -e 's+[^ ]*src="//+http://+g' -i  data_tra$i; sed -e 's+0">[^ ]*+1+g' -i  data_tra$i; tra=`grep -E "[^ ]*" data_tra$i` && echo "$tra" >> ana_tra_prem; rm -f data_tra$i; ((i++)); done && sed -e 's+,+.+g' -i ana_rat_prem; paste ana_tit_prem ana_typ_prem ana_rat_prem ana_tra_prem | while IFS="$(printf '\t')" read -r f1 f2 f3 f4; do printf "%s\n" "$f1" && printf "%s\n" "$f2" && printf "%s\n" "$f3" && printf "%s\n\n" "$f4"; done > ana_premiere; rm -f ana_tra_prem && rm -f ana_typ_prem && rm -f ana_rat_prem; fi && if [ -e data_telerama ]; then grep -E "rel=\"conserver-contexte-recherche\">" data_telerama | sed -e 's+\ +_+g' | sed -e 's+[^ ]*recherche">++g' | sed -e 's+<[^ ]*++g' | sed -e 's+_+\ +g' > ana_tit_tele && n=`wc -l ana_tit_tele | sed -e 's+\ ana_tit_tele++g' | grep -E '[0-99]'` && grep -E -A1 "Réalisé" data_telerama > data_temp && sed -i '/Réalisé/c\' data_temp && echo "--" >> data_temp && sed -e 's+data-href="[^ ]*++g' data_temp | sed -e 's+\ +_+g' | sed -e 's+____________________Avec_________<a__class="obf"><span_itemprop="name">++g' | sed -e 's+<a__class="obf"><span_itemprop="name">++g' | sed -e 's+</span></a>++g' | sed -e 's+__________</p>++g' | sed -e 's+_+\ +g' > data_temp && grep -E "\ " data_temp > ana_act_tele && rm -f data_temp && grep -E "<span\ itemprop=\"genre\">" data_telerama | sed -e 's+\ +_+g' | sed -e 's+[^ ]*genre">++g' | sed -e 's+<[^ ]*++g' | sed -e 's+_+\ +g' > ana_typ_tele && paste ana_tit_tele ana_act_tele ana_typ_tele | while IFS="$(printf '\t')" read -r f1 f2 f3; do printf "Titre : %s\n" "$f1" && printf "%s\n" "$f2" && printf "%s\n\n" "$f3"; done > ana_telerama && rm -f ana_act_tele && rm -f ana_typ_tele; fi && if [ -e data_senscritique ]; then grep -E -A30 "id=\"product-title-" data_senscritique > data_senstmp && grep -E "id=\"product-title-" data_senstmp | sed -e 's+\ +_+g' | sed -e 's+[^ ]*">++g' | sed -e 's+<[^ ]*++g' | sed -e 's+_+\ +g' > ana_tit_sens && n=`wc -l ana_tit_sens | sed -e 's+\ ana_tit_sens++g' | grep -E '[0-99]'` && grep -E "Sortie : <time datetime=" data_senstmp | sed -e 's+\ +_+g' | sed -e 's+\	+_+g' | sed -e 's+[^ ]*_>++g' | sed -e 's+<[^ ]*++g' | sed -e 's+_+\ +g' > ana_out_sens && grep -E "de\ <a\ href=\"" data_senstmp | sed -e 's+\ +_+g' | sed -e 's+\	+_+g' | sed -e 's+[^ ]*">++g' | sed -e 's+<[^ ]*++g' | sed -e 's+_+\ +g' > ana_rea_sens && grep -E -A1 "title=\"Note\ globale\ pondérée\ sur" data_senscritique | sed '1s/^/--\n/' | sed -e 's+\	\	\	\	\	\	++g' | sed -e 's+</a>++g' > data_tmp && i=1 && while ((i!=$n+1)); do t=$((3*$i)) && head -$t data_tmp | tail -1 && ((i++)); done > ana_rat_sens && rm -f data_tmp && sed -e 's+\ +_+g' -i data_senstmp && sed -e 's+\	+_+g' -i data_senstmp && sed -i '/_____<a/c\' data_senstmp && sed -e 's+_______________<span_class=\"eins-sprite_eins-clock__elco-clock\"_>++g' -i data_senstmp && sed -i '/__/c\' data_senstmp && sed -i '/_<\/h2>/c\' data_senstmp && sed -i '/_<p_class=\"elco-baseline\">/c\' data_senstmp && sed -e 's+_++g' -i data_senstmp && sed -e 's+<[^ ]*>++g' -i data_senstmp && sed -i '1s/^/--\n/' data_senstmp && sed -e "s+-+_+g" -i data_senstmp && grep -E -A2 "_" data_senstmp | sed '1s/^/--\n/' > data_timt && i=1 && while ((i!=$n+1)); do t=$((4*$i)) && head -$t data_timt | tail -1 && ((i++)); done > ana_tim_sens && rm -f data_timt && rm -f data_senstmp && sed -e 's+,+.+g' -i ana_rat_sens && sed -e 's+-++g' -i ana_rat_sens && paste ana_tit_sens ana_out_sens ana_rea_sens ana_tim_sens ana_rat_sens | while IFS="$(printf '\t')" read -r f1 f2 f3 f4 f5; do printf "Titre : %s\n" "$f1" && printf "%s\n" "$f2" && printf "%s\n" "$f3" && printf "%s\n" "$f4" && printf "%s\n\n" "$f5"; done > ana_senscritique && rm -f ana_out_sens && rm -f ana_rea_sens && rm -f ana_tim_sens && rm -f ana_rat_sens; fi && sed -e "s+&#039;+'+g" -i ana* && sed -e "s+\&amp;+\&+g" -i ana* && sed -e 's+\ \&\ +\&+g' -i ana*; } && web(){ printf "<!DOCTYPE html'>" > $2 && printf "<html lang='fr'>" >> $2 && printf "<head>" >> $2 && printf "<meta charset='utf-8' />" >> $2 && printf "<title>Fanf Scraper</title>" >> $2 && printf "<link rel='icon' href='https://d27ucmmhxk51xv.cloudfront.net/media/english/illustration/scraper.jpg?version=1.1.81'>" >> $2 && printf "</head>" >> $2 && printf "<body style='background-color:#694741;''>" >> $2 && printf "<div id='conteneur'>" >> $2 && printf "<div id='contenu'>" >> $2 && touch temp && l=1 && a=0 && b=0 && c=0 && d=0 && if [ -e ana_allocine -a $l -le $1 ]; then cat ana_tit_allo >> temp && ((a++)); ((l++)); fi && if [ -e ana_premiere -a $l -le $1 ]; then cat ana_tit_prem >> temp && ((b++)); ((l++)); fi && if [ -e ana_telerama -a $l -le $1 ]; then cat ana_tit_tele >> temp && ((c++)); ((l++)); fi && if [ -e ana_senscritique -a $l -le $1 ]; then cat ana_tit_sens >> temp && ((d++)); ((l++)); fi && sort -u temp > tmp && rm -f temp && uniq -i -w 4 tmp > web_tit && rm -f tmp && n=`wc -l web_tit | sed -e 's+\ web_tit++g' | grep -E '[0-99]'` && i=1 && while ((i!=$n+1)); do t=`head -$i web_tit | tail -1` && printf "<h2><font color=#F5F5DC>%s</font></h2>" "$t" >> $2 && if [ $a -ge 1 ]; then grep -i -A4 "$t" ana_allocine > tmp$i; j=2 && ta1=`head -$j tmp$i | tail -1` && ((j++)) && ta2=`head -$j tmp$i | tail -1` && ((j++)) && ta3=`head -$j tmp$i | tail -1` && ((j++)) && ta4=`head -$j tmp$i | tail -1`; fi && if  [ $b -ge 1 ]; then grep -i -A3 "$t" ana_premiere > tmp$i; j=2 && tp1=`head -$j tmp$i | tail -1` && ((j++)) && tp2=`head -$j tmp$i | tail -1` && ((j++)) && tp3=`head -$j tmp$i | tail -1`; fi && if [ $c -ge 1 ]; then grep -i -A2 "$t" ana_telerama > tmp$i; j=2 && tt1=`head -$j tmp$i | tail -1` && ((j++)) && tt2=`head -$j tmp$i | tail -1`; fi && if [ $d -ge 1 ]; then grep -i -A4 "$t" ana_senscritique > tmp$i; j=2 && ts1=`head -$j tmp$i | tail -1` && ((j++)) && ts2=`head -$j tmp$i | tail -1` && ((j++)) && ts3=`head -$j tmp$i | tail -1` && ((j++)) && ts4=`head -$j tmp$i | tail -1`; fi && g=$tt2 && if [ ${#tp1} -gt ${#tt2} ]; then g=$tp1; fi && printf "<ul>" >> $2 && printf "<li><a href='%s'><font color=#C1B4B1>bande-annonce</font></a></li>" "$tp3" >> $2 && printf "<a href='%s'><img src='%s' /></a></li>" "$tp3" "$ta1" >> $2 && printf "<li><font color=#9A908E>genre : </font><font color=#C1B4B1>%s</font></li>" "$g" >> $2 && printf "<li><font color=#9A908E>synopsis : </font><font color=#C1B4B1>%s</font></li>" "$ta2" >> $2 && printf "<li><font color=#9A908E>réalisateur(s) : </font><font color=#C1B4B1>%s</font></li>" "$ts2" >> $2 && printf "<li><font color=#9A908E>acteurs/rôles : </font><font color=#C1B4B1>%s</font></li>" "$tt1" >> $2 && printf "<li><font color=#9A908E>durée : </font><font color=#C1B4B1>%s</font></li>" "$ts3" >> $2 && printf "<li><font color=#9A908E>sortie le </font><font color=#C1B4B1>%s</font></li>" "$ts1" >> $2 && printf "<li><font color=#9A908E>notes : </font></li>" >> $2 && printf "<ul>" >> $2 && printf "<li><span title='Allociné (Spectateurs)'><font color=#C1B4B1>- %s/5</font></span></li>" "$ta3" >> $2 && printf "<li><span title='Allociné (Presse)'><font color=#C1B4B1>- %s/5</font></span></li>" "$ta4" >> $2 && printf "<li><span title='Première'><font color=#C1B4B1>- %s/5</font></span></li>" "$tp2" >> $2 && printf "<li><span title='Sens critique'><font color=#C1B4B1>- %s/10</font></span></li>" "$ts4" >> $2 && printf "</ul>" >> $2 && printf "</ul>" >> $2 && ((i++)); done && rm -f web_tit && rm -f tmp*; } && hlp(){ echo "Options :" && echo "-i		Initialisation du fichier des sites." && echo "-c		Effacement des téléchargements." && echo "-e 		Effacement des analyses." && echo "-t date site	Téléchargement des sorties cinéma du 'site' à la 'date' donnée. Si 'site' est '-' alors on télécharge tous les sites." && echo "-s date site	Comme -t mais en localhost." && echo "-a		Analyse des fichiers préalablement téléchargés." && echo "-w lien page 	Fabrication de la page web qui portera le nom 'page' à partir d'un nombre minimum de sites de 'lien'." && echo "-h		Affichage de cet aide."; } && error(){ echo "enter a valid argument, here is the help page :" && ./scraper.sh -h; }; while [ ! -z $1 ] ; do case $1 in -t)download $2 $3; shift 3;; -s)locald $2 $3; shift 3;; -w)web $2 $3; shift 3;; -i)initialisation; shift 1;; -c)cleard; shift 1;; -e)erase; shift 1;; -a)analysis; shift 1;; -h)hlp; shift 1;; -r)remove; shift 1;; *)error; exit 0;;esac; done